 /* === Copyright © 2025 5kaideta_yuuto All rights reserved === */
 /* === Producted by aixai-dayo-yt === */
const B={White:[200,203,207], "Light Gray":[135,137,140],Gray:[80,80,84],Black:[25,27,30],Brown:[95,60,42],Red:[142,38,32],Orange:[220,94,25],Yellow:[237,178,20],Lime:[95,169,21],Green:[77,98,32],Cyan:[18,126,133],"Light Blue":[65,137,186],Blue:[43,44,138],Purple:[112,45,166],Magenta:[178,59,141],Pink:[215,108,138]};
function cd(a,b){return (a[0]-b[0])**2+(a[1]-b[1])**2+(a[2]-b[2])**2}
function f(rgb){let best='White',m=1/0;for(const k in B){const d=cd(rgb,B[k]);if(d<m){m=d;best=k}}return best}
const T={ja:{title:"Bloxd ドット絵コンバーター ver. 1.0.0",subtitle:"Code Blockの制限 (15,000文字) に合わせてコードを自動分割し、画像のドット絵を生成します。",credit:'このコンバーターは、<a href="https://github.com/aixai-dayo-yt" target="_blank" class="text-bloxd-primary hover:underline">AIXAI_YT</a> さんが作成したものを基礎として作成しています。',step1:"画像をアップロードと描画設定",startPos:"描画開始座標 (X, Y, Z)",startDesc:"Code Blockが設置された位置を基準とした絶対座標を入力してください。",resolution:"解像度 (N x N ブロック)",resolutionOptions:["20x20 (400ブロック)","30x30 (900ブロック)","40x40 (1600ブロック)","50x50 (2500ブロック)","75x75 (5625ブロック)","100x100 (10000ブロック)"],upload:"画像をアップロード",palatte:"パレット: Concrete (16色) を使用します。",convertBtn:"変換してコードを生成",converting:"画像を解析し、Code Block 用のコードを生成中...",step2:"プレビューと Code Block 用コード",previewTitle:"変換プレビュー",previewDesc:"Code Blockで描画されるドット絵の見た目です。",outputWarn:"⚠️ Code Block ごとに内容をコピーし、順番に Code Block に貼り付けて実行してください。",copy:"コードをコピー",copyOk:"✅ コピーしました！",uploaded:"をアップロードしました",generated:"生成しました",done:"✅ ドット絵を描画しました",codeMsg:"コードブロック Javascript (最大15,000文字で分割)"},en:{title:"Bloxd Pixel Art Converter ver. 1.0.0",subtitle:"Automatically converts images into Code Block scripts under the 15,000 character limit.",credit:'This converter is based on the one created by <a href="https://github.com/aixai-dayo-yt" target="_blank" class="text-bloxd-primary hover:underline">AIXAI_YT</a>.',step1:"Image Upload & Draw Settings",startPos:"Start Position (X, Y, Z)",startDesc:"Set the absolute block coordinates for drawing.",resolution:"Resolution (N x N Blocks)",resolutionOptions:["20x20 (400 blocks)","30x30 (900 blocks)","40x40 (1600 blocks)","50x50 (2500 blocks)","75x75 (5625 blocks)","100x100 (10000 blocks)"],upload:"Upload Image",palatte:"Palette: used is Concrete (16 colors).",convertBtn:"Convert to Code",converting:"Parsing image & generating code for Code Blocks...",step2:"Preview & Code Block Output",previewTitle:"Preview",previewDesc:"How the pixel art will look in Code Blocks.",outputWarn:"⚠️ Copy and paste each block script into Code Blocks in order.",copy:"Copy Code",copyOk:"✅ Copied!",uploaded:"uploaded",generated:"Generated",done:"✅ Pixel art drawn!",codeMsg:"Code Block Javascript (Split into a maximum of 15,000 blocks.)"}};
let L='ja';
function sT(text,k='info',t=2500){document.querySelector('.toast-message')?.remove();const el=document.createElement('div');el.className='toast-message';el.style.background=(k==='error')?'#dc2626':'#0ea5e9';el.textContent=text;document.body.appendChild(el);el.style.transform='translateX(0)';setTimeout(()=>{el.style.transform='translateX(120%)';el.addEventListener('transitionend',()=>el.remove())},t)}
function aIR(file,size){return new Promise((res,rej)=>{const img=new Image(),r=new FileReader();r.onload=e=>img.src=e.target.result;img.onload=()=>{const cvs=document.createElement('canvas');cvs.width=size;cvs.height=size;const ctx=cvs.getContext('2d');ctx.drawImage(img,0,0,size,size);const d=ctx.getImageData(0,0,size,size).data;const runs={};for(let y=0;y<size;y++){runs[y]=[];let cur=null,start=0;for(let x=0;x<size;x++){const i=(y*size+x)*4;const clr=f([d[i],d[i+1],d[i+2]])+" Concrete";if(!cur){cur=clr;start=x}else if(cur!==clr){runs[y].push({zStart:start,zEnd:x-1,color:cur});cur=clr;start=x}}if(cur){runs[y].push({zStart:start,zEnd:size-1,color:cur})}}res({width:size,height:size,runs})};r.onerror=rej;r.readAsDataURL(file)})}
function gB(runs,sx,sy,sz){const MAX_SIZE=13000,blocks=[],addLines=(a,b)=>{a.push(b)};let blockIndex=1,cur=[],sizeCount=0;const openf=()=>{cur=[];sizeCount=0;addLines(cur,`(function(){`);addLines(cur,`  const X=${sx};`);addLines(cur,`  const topY=${sy};`);addLines(cur,`  const Z0=${sz};`)};const closef=isLast=>{if(isLast){addLines(cur,`  api.sendMessage(myId,"ブロック${blockIndex}（最後）の描画が終わりました");`)}else addLines(cur,`  api.sendMessage(myId,"ブロック${blockIndex}の描画が終わりました");`);addLines(cur,`})();`);blocks.push(cur.join("\n"));blockIndex++};openf();for(let y=0;y<runs.height;y++){const wy=`topY + ${runs.height-1-y}`;for(const run of runs.runs[y]){const zA=runs.width-1-run.zStart;const zB=runs.width-1-run.zEnd;const hi=Math.max(zA,zB);const lo=Math.min(zA,zB);let line;if(hi===lo){line=`  api.setBlock(X,${wy},Z0+${hi},"${run.color}");`}else{line=`  for(let z=Z0+${hi}; z>=Z0+${lo}; z--) api.setBlock(X,${wy},z,"${run.color}");`}if(sizeCount+line.length>MAX_SIZE){closef(false);openf()}cur.push(line);sizeCount+=line.length+1}}closef(true);return blocks}
function dP(runs){const cvs=document.getElementById('previewCanvas');const ctx=cvs.getContext('2d');cvs.width=runs.width;cvs.height=runs.height;ctx.imageSmoothingEnabled=false;for(let y=0;y<runs.height;y++){for(const r of runs.runs[y]){const rgb=B[r.color.replace(' Concrete','')]||[0,0,0];ctx.fillStyle=`rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;ctx.fillRect(r.zStart,y,(r.zEnd-r.zStart+1),1)}}}
function rU(blocks){const tabButtons=document.getElementById('tabButtons'),tabContent=document.getElementById('tabContent');tabButtons.innerHTML='';tabContent.innerHTML='';blocks.forEach((code,i)=>{const n=i+1;const btn=document.createElement('button');btn.className='tab-button px-4 py-2 rounded-t-lg bg-gray-200 hover:bg-gray-300 transition';btn.textContent=`Block ${n}`;if(n===1)btn.classList.add('active');tabButtons.appendChild(btn);const pane=document.createElement('div');pane.className='tab-pane';pane.style.display=(n===1?'block':'none');const ta=document.createElement('textarea');ta.value=code;ta.readOnly=true;ta.rows=18;ta.className='w-full p-4 border border-gray-700 rounded-lg bg-code-dark text-lime-400 font-mono text-xs custom-scrollbar shadow-inner';const cp=document.createElement('button');cp.textContent=T[L].copy;cp.className='copy-btn';cp.onclick=()=>{ta.select();document.execCommand('copy');sT(T[L].copyOk)};pane.appendChild(ta);pane.appendChild(cp);tabContent.appendChild(pane);btn.onclick=()=>{document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(p=>p.style.display='none');btn.classList.add('active');pane.style.display='block'}})}
async function sC(){const fileInput=document.getElementById('imageUpload');if(!fileInput.files[0]){sT("画像を選択してください",'error');return}const size=parseInt(resolution.value),sx=parseInt(startX.value),sy=parseInt(startY.value),sz=parseInt(startZ.value);const loading=document.getElementById('loading');loading.classList.remove('hidden');try{const runs=await aIR(fileInput.files[0],size);dP(runs);const blocks=gB(runs,sx,sy,sz);rU(blocks);loading.classList.add('hidden');outputSection.style.display='block';sT(T[L].generated)}catch(e){console.error(e);loading.classList.add('hidden');sT("エラーが発生しました",'error')}}
function uP(bs){const previewCanvas=document.getElementById('previewCanvas');if(!previewCanvas) return;const ctx=previewCanvas.getContext('2d');previewCanvas.width=bs;previewCanvas.height=bs;const containerWidth=previewCanvas.parentElement.offsetWidth*0.9;const size=Math.min(containerWidth,400);previewCanvas.style.width=size+'px';previewCanvas.style.height=size+'px';if(ctx){ctx.setTransform(1,0,0,1,0,0);ctx.imageSmoothingEnabled=false}}
function populateResolutionOptions(lang){const sel=document.getElementById('resolution');const opts=T[lang].resolutionOptions;sel.innerHTML='';const values=[20,30,40,50,75,100];for(let i=0;i<opts.length;i++){const o=document.createElement('option');o.value=String(values[i]);o.textContent=opts[i];if(values[i]===20)o.selected=true;sel.appendChild(o)}}
function applyLanguage(lang){L=lang;const t=T[lang];document.querySelector('h1').textContent=t.title;document.querySelector('.subtitle').textContent=t.subtitle;document.getElementById('credit').innerHTML=`<span class="credit-box">${t.credit} </span>`;document.getElementById('step1-title').textContent=t.step1;document.getElementById('label-startpos').textContent=t.startPos;document.getElementById('start-desc').textContent=t.startDesc;document.getElementById('label-resolution').textContent=t.resolution;populateResolutionOptions(lang);document.getElementById('label-upload').textContent=t.upload;document.getElementById('label-palette').textContent=t.palatte;document.getElementById('convert-button-text').textContent=t.convertBtn;document.getElementById('loading-text').textContent=t.converting;document.getElementById('step2-title').textContent=t.step2;document.getElementById('previewTitle').textContent=`${t.previewTitle} (${document.getElementById('resolution').value}x${document.getElementById('resolution').value})`;document.getElementById('preview-desc').textContent=t.previewDesc;document.getElementById('codeTitle').textContent=t.codeMsg;document.getElementById('outputWarn').textContent=t.outputWarn;document.querySelectorAll('.copy-btn').forEach(b=>b.textContent=t.copy)}
document.addEventListener('DOMContentLoaded',()=>{const langSelect=document.getElementById('langSelect');if(langSelect){langSelect.value=L;langSelect.addEventListener('change',()=>applyLanguage(langSelect.value))}applyLanguage(L);const resolutionSelect=document.getElementById('resolution');resolutionSelect.addEventListener('change',()=>{const newSize=parseInt(resolutionSelect.value);uP(newSize);const previewResolution=document.getElementById('previewResolution');if(previewResolution)previewResolution.textContent=newSize+"x"+newSize;const previewTitle=document.getElementById('previewTitle');if(previewTitle)previewTitle.textContent=`${T[L].previewTitle} (${newSize}x${newSize})`;document.getElementById('outputSection').style.display='none';document.getElementById('tabButtons').innerHTML='';document.getElementById('tabContent').innerHTML=''});document.getElementById('convertButton').addEventListener('click',()=>{sC();sT(T[L].generated,'info',1500)});const imageInput=document.getElementById('imageUpload');imageInput.addEventListener('change',function(){if(this.files.length===0) return;const filename=this.files[0].name;const fileNameElem=document.getElementById('uploadFileName');fileNameElem.textContent=filename+' '+T[L].uploaded;fileNameElem.classList.remove('hidden');sT(`${filename} ${T[L].uploaded}`,'info',2000)});const tabContent=document.getElementById('tabContent');tabContent.innerHTML=`<textarea id="outputCodePlaceholder" rows="12" readonly class="w-full p-4 border border-gray-700 rounded-lg bg-code-dark text-lime-400 font-mono text-xs custom-scrollbar shadow-inner">/* ${T[L].startDesc} */</textarea><p id="copyMessage" class="mt-3 px-3 py-1 bg-green-100 text-green-700 font-semibold rounded inline-block hidden">${T[L].copyOk}</p>`});
